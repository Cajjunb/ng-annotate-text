(function(){var getAnnotationById,insertAt,ngAnnotate,parseAnnotations,sortAnnotationsByEndIndex;ngAnnotate=angular.module("ngAnnotate",[]),insertAt=function(text,index,string){return text.substr(0,index)+string+text.substr(index)},sortAnnotationsByEndIndex=function(annotations){return annotations.sort(function(a,b){return a.endIndex<b.endIndex?-1:a.endIndex>b.endIndex?1:0})},parseAnnotations=function(text,annotations,indexOffset){var annotation,i,_i,_ref;if(null==annotations&&(annotations=[]),null==indexOffset&&(indexOffset=0),0===annotations.length)return text;for(annotations=sortAnnotationsByEndIndex(annotations),i=_i=_ref=annotations.length-1;_i>=0;i=_i+=-1)annotation=annotations[i],text=insertAt(text,annotation.endIndex+indexOffset,"</span>"),annotation.children.length&&(text=parseAnnotations(text,annotation.children,annotation.startIndex+indexOffset)),text=insertAt(text,annotation.startIndex+indexOffset,'<span class="ng-annotation ng-annotation-'+annotation.id+" "+annotation.type+'" data-annotation-id="'+annotation.id+'">');return text},getAnnotationById=function(annotations,aId){var a,an,_i,_len;for(_i=0,_len=annotations.length;_len>_i;_i++){if(a=annotations[_i],aId===a.id)return a;if(a.children.length>0&&(an=getAnnotationById(a.children,aId),void 0!==an))return an}},ngAnnotate.factory("NGAnnotatePopup",function(){var NGAnnotatePopup;return NGAnnotatePopup=function(scope){return angular.extend(this,{scope:scope,$el:angular.element('<div class="ng-annotation-popup" />'),$anchor:null,show:function(cb,speed){return null==cb&&(cb=angular.noop),null==speed&&(speed="fast"),this.$el.fadeIn(speed,cb)},hide:function(cb,speed){return null==cb&&(cb=angular.noop),null==speed&&(speed="fast"),this.$el.fadeOut(speed,cb)},isVisible:function(){return this.$el.is(":visible")},positionTop:function(){var anchorHeight,anchorOffsetTop,popupHeight;if(null==this.$anchor)throw new Error("NG_ANNOTATE_NO_ANCHOR");return anchorOffsetTop=this.$anchor.offset().top,anchorHeight=this.$anchor.innerHeight(),popupHeight=this.$el.innerHeight(),this.$el.css({top:anchorOffsetTop+anchorHeight/2-popupHeight/2})},positionLeft:function(value){return this.$el.css({left:value})},destroy:function(){var $el;return scope=this.scope,$el=this.$el,this.hide(function(){return scope.$destroy(),$el.remove()})}})}}),ngAnnotate.factory("NGAnnotateTooltip",function(){var NGAnnotateTooltip;return NGAnnotateTooltip=function(scope){return angular.extend(this,{scope:scope,$el:angular.element('<div class="ng-annotation-tooltip" />'),$anchor:null,show:function(cb,speed){return null==cb&&(cb=angular.noop),null==speed&&(speed="fast"),this.$el.fadeIn(speed,cb)},hide:function(cb,speed){return null==cb&&(cb=angular.noop),null==speed&&(speed="fast"),this.$el.fadeOut(speed,cb)},isVisible:function(){return this.$el.is(":visible")},positionTop:function(){var anchorHeight,anchorOffsetTop,tooltipHeight;if(null==this.$anchor)throw new Error("NG_ANNOTATE_NO_ANCHOR");return anchorOffsetTop=this.$anchor.offset().top,anchorHeight=this.$anchor.innerHeight(),tooltipHeight=this.$el.innerHeight(),this.$el.css({top:anchorOffsetTop+anchorHeight/2-tooltipHeight/2})},positionLeft:function(value){return this.$el.css({left:value})},destroy:function(){var $el;return scope=this.scope,$el=this.$el,this.hide(function(){return scope.$destroy(),$el.remove()})}})}}),ngAnnotate.factory("NGAnnotation",function(){var Annotation;return Annotation=function(data){return angular.extend(this,{id:(new Date).getTime(),startIndex:null,endIndex:null,data:{},type:"",children:[]}),null!=data?angular.extend(this,data):void 0}}),ngAnnotate.directive("ngAnnotate",function($rootScope,$compile,$http,$q,NGAnnotation,NGAnnotatePopup,NGAnnotateTooltip){return{restrict:"A",scope:{text:"=",annotations:"=",options:"=",onAnnotate:"=",onAnnotateError:"="},compile:function(tElement){return function($scope,element){var activePopups,activeTooltips,clearPopups,clearTooltips,createAnnotation,getPopupTemplate,getTooltipTemplate,onAnnotationsChange,onClick,onMouseEnter,onMouseLeave,onSelect,options,popupTemplateData,removeAnnotation,removeChildren,tooltipTemplateData;return activePopups=[],activeTooltips=[],popupTemplateData="",tooltipTemplateData="",onAnnotationsChange=function(){var t;if($scope.text.length)return t=parseAnnotations($scope.text,$scope.annotations),tElement.html(t)},$scope.$watch("annotations",onAnnotationsChange,!0),options={popupTemplateUrl:"",tooltipTemplateUrl:""},options=angular.extend(options,$scope.options),clearPopups=function(){var p,_i,_len;for(_i=0,_len=activePopups.length;_len>_i;_i++)p=activePopups[_i],p.destroy();return activePopups=[]},clearTooltips=function(){var t,_i,_len;for(_i=0,_len=activeTooltips.length;_len>_i;_i++)t=activeTooltips[_i],t.destroy();return activeTooltips=[]},$scope.$on("$destroy",function(){return clearPopups()}),getPopupTemplate=function(url){var deferred;return popupTemplateData.length?(deferred=$q.defer(),deferred.resolve(popupTemplateData),deferred.promise):$http.get(url).then(function(response){return popupTemplateData=response.data,response.data})},getTooltipTemplate=function(url){var deferred;return tooltipTemplateData.length?(deferred=$q.defer(),deferred.resolve(tooltipTemplateData),deferred.promise):$http.get(url).then(function(response){return tooltipTemplateData=response.data,response.data})},removeChildren=function(annotation){var a,i,_i,_ref,_results;for(_results=[],i=_i=_ref=annotation.children.length-1;_i>=0;i=_i+=-1)a=annotation.children[i],removeChildren(a),_results.push(a.children.splice(i,1));return _results},removeAnnotation=function(id,annotations){var a,i,_i,_len;for(i=_i=0,_len=annotations.length;_len>_i;i=++_i)if(a=annotations[i],a.id===id)return removeChildren(a),void annotations.splice(i,1)},createAnnotation=function(){var annotation,annotationParentCollection,attrId,parentAnnotation,parentId,prevAnnotation,prevSiblingId,prevSiblingSpan,range,sel;if(annotation=new NGAnnotation,sel=window.getSelection(),"Range"!==sel.type)throw new Error("NG_ANNOTATE_NO_TEXT_SELECTED");if(range=sel.getRangeAt(0),range.startContainer!==range.endContainer)throw new Error("NG_ANNOTATE_PARTIAL_NODE_SELECTED");if("SPAN"===range.startContainer.parentElement.nodeName){if(parentId=null!=(attrId=range.startContainer.parentElement.getAttribute("data-annotation-id"))?parseInt(attrId,10):void 0,void 0===parentId)throw new Error("NG_ANNOTATE_ILLEGAL_SELECTION");parentAnnotation=getAnnotationById($scope.annotations,parentId),annotationParentCollection=parentAnnotation.children}else annotationParentCollection=$scope.annotations;if(annotationParentCollection.length)if(prevSiblingSpan=range.startContainer.previousSibling,null!=prevSiblingSpan){if(prevSiblingId=null!=(attrId=prevSiblingSpan.getAttribute("data-annotation-id"))?parseInt(attrId,10):void 0,null==prevSiblingId)throw new Error("NG_ANNOTATE_ILLEGAL_SELECTION");prevAnnotation=getAnnotationById($scope.annotations,prevSiblingId),annotation.startIndex=prevAnnotation.endIndex+range.startOffset,annotation.endIndex=prevAnnotation.endIndex+range.endOffset}else annotation.startIndex=range.startOffset,annotation.endIndex=range.endOffset;else annotation.startIndex=range.startOffset,annotation.endIndex=range.endOffset;return annotationParentCollection.push(annotation),annotation},onSelect=function(){var $span,annotation,ex,getTemplatePromise,popup;try{annotation=createAnnotation(),$scope.$apply(),$span=element.find(".ng-annotation-"+annotation.id)}catch(_error){return ex=_error,void $scope.onAnnotateError(ex)}return clearPopups(),clearTooltips(),popup=new NGAnnotatePopup($rootScope.$new()),popup.scope.$isNew=!0,popup.scope.$annotation=annotation,popup.$anchor=$span,popup.scope.$reject=function(){return removeAnnotation(annotation.id,$scope.annotations),clearPopups(),popup.destroy()},popup.scope.$close=function(){return $scope.onAnnotate(popup.scope.$annotation),clearPopups(),popup.destroy()},activePopups.push(popup),getTemplatePromise=getPopupTemplate(options.popupTemplateUrl),getTemplatePromise.then(function(template){return $compile(angular.element(template))(popup.scope,function($content){return popup.$el.html($content),popup.$el.appendTo("body"),popup.positionTop(),popup.positionLeft(element.offset().left-320),popup.show()})})},onClick=function(event){var $target,attrId,getTemplatePromise,p,popup,targetId,_i,_len;if($target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null!=targetId){if(activePopups.length)for(_i=0,_len=activePopups.length;_len>_i;_i++)if(p=activePopups[_i],null!=p.scope&&p.scope.$annotation.id===targetId)return void clearPopups();return clearPopups(),clearTooltips(),popup=new NGAnnotatePopup($rootScope.$new()),popup.scope.$isNew=!1,popup.scope.$annotation=getAnnotationById($scope.annotations,targetId),popup.$anchor=$target,popup.scope.$reject=function(){return removeAnnotation(targetId,$scope.annotations),clearPopups(),popup.destroy()},popup.scope.$close=function(){return $scope.onAnnotate(popup.scope.$annotation),clearPopups(),popup.destroy()},activePopups.push(popup),getTemplatePromise=getPopupTemplate(options.popupTemplateUrl),getTemplatePromise.then(function(template){return $compile(angular.element(template))(popup.scope,function($content){return popup.$el.html($content),popup.$el.appendTo("body"),popup.positionTop(),popup.positionLeft(element.offset().left-320),popup.show()})})}},onMouseEnter=function(event){var $target,annotation,attrId,getTemplatePromise,targetId,tooltip;return $target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null==targetId||(annotation=getAnnotationById($scope.annotations,targetId),activePopups.length)?void 0:(clearTooltips(),tooltip=new NGAnnotateTooltip($rootScope.$new()),tooltip.scope.$annotation=annotation,tooltip.$anchor=$target,activeTooltips.push(tooltip),getTemplatePromise=getTooltipTemplate(options.tooltipTemplateUrl),getTemplatePromise.then(function(template){return $compile(angular.element(template))(tooltip.scope,function($content){return tooltip.$el.html($content),tooltip.$el.appendTo("body"),tooltip.positionTop(),tooltip.positionLeft(element.offset().left-320),tooltip.show()})}))},onMouseLeave=function(event){var $target,attrId,targetId;return $target=angular.element(event.target),targetId=null!=(attrId=$target.attr("data-annotation-id"))?parseInt(attrId,10):void 0,null!=targetId?clearTooltips():void 0},element.on("mouseover","span",onMouseEnter),element.on("mouseleave","span",onMouseLeave),element.on("mouseup",function(event){var selection;return selection=window.getSelection(),"Range"===selection.type?onSelect(event):"Caret"===selection.type&&"SPAN"===event.target.nodeName?onClick(event):void 0})}}}})}).call(this);